"""
AutoGen å¤šæ— äººæœºä»»åŠ¡åˆ†é…ç³»ç»Ÿ
åŸºäºå¤šæ™ºèƒ½ä½“åä½œçš„æ— äººæœºä»»åŠ¡æ™ºèƒ½åˆ†é…æ¡†æ¶
"""

import os
import json
import asyncio
from datetime import datetime
from typing import List, Dict, Any
from dotenv import load_dotenv

# åŠ è½½ç¯å¢ƒå˜é‡
load_dotenv()

# AutoGen æ¡†æ¶å¯¼å…¥
from autogen_ext.models.openai import OpenAIChatCompletionClient
from autogen_agentchat.agents import AssistantAgent
from autogen_agentchat.teams import RoundRobinGroupChat
from autogen_agentchat.conditions import TextMentionTermination, MaxMessageTermination
from autogen_agentchat.ui import Console

def create_openai_model_client():
    """åˆ›å»º OpenAI æ¨¡å‹å®¢æˆ·ç«¯"""
    model_name = os.getenv("LLM_MODEL_ID", "gpt-4o")
    
    # ä¸ºéOpenAIæ ‡å‡†æ¨¡å‹æä¾›æ¨¡å‹ä¿¡æ¯
    model_info = None
    if model_name not in ["gpt-4o", "gpt-4o-mini", "gpt-4-turbo", "gpt-4", "gpt-3.5-turbo"]:
        model_info = {
            "family": "unknown",
            "vision": False,
            "function_calling": True,
            "json_output": True,
            "context_window": 32768,
        }
    
    return OpenAIChatCompletionClient(
        model=model_name,
        api_key=os.getenv("LLM_API_KEY"),
        base_url=os.getenv("LLM_BASE_URL", "https://api.openai.com/v1"),
        model_info=model_info
    )

def create_task_analyzer(model_client):
    """åˆ›å»ºä»»åŠ¡åˆ†ææ™ºèƒ½ä½“"""
    system_message = """ä½ æ˜¯ä¸€ä½ä¸“ä¸šçš„æ— äººæœºä»»åŠ¡åˆ†æä¸“å®¶ï¼Œè´Ÿè´£è§£æå’Œç†è§£è¾“å…¥çš„ä»»åŠ¡éœ€æ±‚ã€‚

ä½ çš„æ ¸å¿ƒèŒè´£ï¼š
1. **ä»»åŠ¡è§£æ**ï¼šä»è¾“å…¥ä¸­æå–ä»»åŠ¡åˆ—è¡¨ã€ç›®æ ‡ä½ç½®ã€æ—¶é—´çº¦æŸã€ä¼˜å…ˆçº§ç­‰å…³é”®ä¿¡æ¯
2. **ä»»åŠ¡åˆ†ç±»**ï¼šå°†ä»»åŠ¡æŒ‰ç±»å‹åˆ†ç±»ï¼ˆä¾¦å¯Ÿã€è¿è¾“ã€ç›‘æ§ã€æ‰“å‡»ç­‰ï¼‰
3. **çº¦æŸè¯†åˆ«**ï¼šè¯†åˆ«æ—¶é—´çª—å£ã€åœ°ç†é™åˆ¶ã€ä»»åŠ¡ä¾èµ–ç­‰çº¦æŸæ¡ä»¶
4. **éœ€æ±‚é‡åŒ–**ï¼šä¼°ç®—æ¯ä¸ªä»»åŠ¡æ‰€éœ€çš„èµ„æºå’Œèƒ½åŠ›è¦æ±‚

åˆ†æè¦ç‚¹ï¼š
- è¯†åˆ«æ¯ä¸ªä»»åŠ¡çš„å…³é”®å±æ€§ï¼ˆä½ç½®ã€æ—¶é—´çª—å£ã€ä¼˜å…ˆçº§ã€ç±»å‹ã€æŒç»­æ—¶é—´ï¼‰
- è¯†åˆ«ä»»åŠ¡é—´çš„ä¾èµ–å…³ç³»å’Œå†²çª
- æå–çº¦æŸæ¡ä»¶ï¼ˆç¦é£åŒºã€æ—¶é—´é™åˆ¶ç­‰ï¼‰
- å¯¹ä»»åŠ¡è¿›è¡Œä¼˜å…ˆçº§æ’åº

è¾“å‡ºæ ¼å¼ï¼š
è¯·ä»¥ç»“æ„åŒ–çš„æ–¹å¼è¾“å‡ºä»»åŠ¡åˆ†æç»“æœï¼ŒåŒ…æ‹¬ï¼š
- ä»»åŠ¡æ€»æ•°åŠåˆ†ç±»ç»Ÿè®¡
- æ¯ä¸ªä»»åŠ¡çš„è¯¦ç»†å±æ€§
- å…³é”®çº¦æŸæ¡ä»¶
- ä»»åŠ¡ä¼˜å…ˆçº§æ’åºå»ºè®®

åˆ†æå®Œæˆåè¯´"âœ… ä»»åŠ¡åˆ†æå®Œæˆï¼Œè¯·èµ„æºè¯„ä¼°Agentè¯„ä¼°æ— äººæœºèƒ½åŠ›"ã€‚"""

    return AssistantAgent(
        name="TaskAnalyzer",
        model_client=model_client,
        system_message=system_message,
    )

def create_resource_evaluator(model_client):
    """åˆ›å»ºèµ„æºè¯„ä¼°æ™ºèƒ½ä½“"""
    system_message = """ä½ æ˜¯ä¸€ä½æ— äººæœºèµ„æºè¯„ä¼°ä¸“å®¶ï¼Œè´Ÿè´£è¯„ä¼°å¯ç”¨æ— äººæœºçš„èƒ½åŠ›å’ŒçŠ¶æ€ã€‚

ä½ çš„æ ¸å¿ƒèŒè´£ï¼š
1. **èƒ½åŠ›è¯„ä¼°**ï¼šè¯„ä¼°æ¯æ¶æ— äººæœºçš„è½½è·ã€ç»­èˆªã€é€Ÿåº¦ã€ä¼ æ„Ÿå™¨ç­‰èƒ½åŠ›
2. **çŠ¶æ€æ£€æŸ¥**ï¼šç¡®è®¤æ— äººæœºå½“å‰ä½ç½®ã€ç”µé‡ã€å¯ç”¨æ€§
3. **é€‚é…åˆ†æ**ï¼šåˆ†ææ¯æ¶æ— äººæœºé€‚åˆæ‰§è¡Œå“ªäº›ç±»å‹çš„ä»»åŠ¡
4. **çº¦æŸè¯†åˆ«**ï¼šè¯†åˆ«æ— äººæœºçš„ä½œä¸šé™åˆ¶ï¼ˆç¦é£åŒºã€å¤©æ°”å½±å“ç­‰ï¼‰

è¯„ä¼°ç»´åº¦ï¼š
- **é£è¡Œèƒ½åŠ›**ï¼šæœ€å¤§èˆªç¨‹ã€æœ€å¤§è½½é‡ã€æœ€é«˜é€Ÿåº¦ã€ç»­èˆªæ—¶é—´
- **ä»»åŠ¡èƒ½åŠ›**ï¼šæ”¯æŒçš„ä»»åŠ¡ç±»å‹ã€æ­è½½çš„è®¾å¤‡å’Œä¼ æ„Ÿå™¨
- **å½“å‰çŠ¶æ€**ï¼šä½ç½®ã€ç”µé‡ç™¾åˆ†æ¯”ã€ç»´æŠ¤çŠ¶æ€ã€å¯ç”¨æ€§
- **å¯ç”¨æ—¶é—´çª—å£**ï¼šè€ƒè™‘å……ç”µã€ç»´æŠ¤ç­‰å› ç´ 

è¯„ä¼°è¾“å‡ºï¼š
- æ¯æ¶æ— äººæœºçš„è¯¦ç»†èƒ½åŠ›å‚æ•°
- æ— äººæœºä¸ä»»åŠ¡ç±»å‹çš„åŒ¹é…åº¦åˆ†æ
- è¯†åˆ«èƒ½åŠ›ç“¶é¢ˆå’Œèµ„æºé™åˆ¶
- æå‡ºèµ„æºè°ƒé…å»ºè®®

è¯„ä¼°å®Œæˆåè¯´"âœ… èµ„æºè¯„ä¼°å®Œæˆï¼Œè¯·æ–¹æ¡ˆç”ŸæˆAgentæå‡ºåˆ†é…æ–¹æ¡ˆ"ã€‚"""

    return AssistantAgent(
        name="ResourceEvaluator",
        model_client=model_client,
        system_message=system_message,
    )

def create_solution_generator(model_client):
    """åˆ›å»ºæ–¹æ¡ˆç”Ÿæˆæ™ºèƒ½ä½“"""
    system_message = """ä½ æ˜¯ä¸€ä½æ— äººæœºä»»åŠ¡åˆ†é…æ–¹æ¡ˆä¸“å®¶ï¼Œè´Ÿè´£æ ¹æ®ä»»åŠ¡éœ€æ±‚å’Œèµ„æºæƒ…å†µç”Ÿæˆåˆ†é…æ–¹æ¡ˆã€‚

ä½ çš„æ ¸å¿ƒèŒè´£ï¼š
1. **æ–¹æ¡ˆè®¾è®¡**ï¼šåŸºäºä»»åŠ¡åˆ†æå’Œèµ„æºè¯„ä¼°ï¼Œè®¾è®¡ä»»åŠ¡åˆ†é…æ–¹æ¡ˆ
2. **ä¼˜åŒ–è€ƒé‡**ï¼šè€ƒè™‘æ•ˆç‡ã€æˆæœ¬ã€é£é™©ç­‰å¤šç›®æ ‡ä¼˜åŒ–
3. **å¤šæ–¹æ¡ˆç”Ÿæˆ**ï¼šæä¾›1-2ä¸ªå€™é€‰æ–¹æ¡ˆä¾›è®¨è®º
4. **æ–¹æ¡ˆè¯´æ˜**ï¼šè§£é‡Šæ¯ä¸ªæ–¹æ¡ˆçš„ä¼˜ç¼ºç‚¹å’Œé€‰æ‹©ç†ç”±

æ–¹æ¡ˆç”ŸæˆåŸåˆ™ï¼š
- **ä¼˜å…ˆçº§åŒ¹é…**ï¼šé«˜ä¼˜å…ˆçº§/ç´§æ€¥ä»»åŠ¡ä¼˜å…ˆåˆ†é…ç»™æœ€åˆé€‚çš„æ— äººæœº
- **è·ç¦»ä¼˜åŒ–**ï¼šå‡å°‘æ— äººæœºé£è¡Œè·ç¦»ï¼Œæé«˜æ•ˆç‡
- **è´Ÿè½½å‡è¡¡**ï¼šé¿å…æŸäº›æ— äººæœºè¿‡è½½ï¼Œåˆç†åˆ†é…å·¥ä½œé‡
- **æ—¶é—´åè°ƒ**ï¼šç¡®ä¿æ—¶é—´çª—å£ä¸å†²çªï¼Œè€ƒè™‘ä»»åŠ¡æ‰§è¡Œé¡ºåº
- **èƒ½åŠ›åŒ¹é…**ï¼šç¡®ä¿åˆ†é…çš„æ— äººæœºå…·å¤‡æ‰§è¡Œä»»åŠ¡çš„èƒ½åŠ›
- **å†—ä½™è€ƒè™‘**ï¼šå¯¹å…³é”®ä»»åŠ¡è€ƒè™‘å¤‡ä»½æ–¹æ¡ˆ

è¾“å‡ºæ ¼å¼ç¤ºä¾‹ï¼š
```
ã€æ–¹æ¡ˆA - ä¼˜å…ˆçº§ä¼˜å…ˆç­–ç•¥ã€‘
åˆ†é…è¯¦æƒ…ï¼š
- T4ï¼ˆç´§æ€¥ä¾¦å¯Ÿï¼‰â†’ UAV-001ï¼ˆæœ€å¿«é€Ÿåº¦ï¼Œç«‹å³å‡ºå‘ï¼‰
- T1ï¼ˆé«˜ä¼˜å…ˆçº§ä¾¦å¯Ÿï¼‰â†’ UAV-003ï¼ˆBåŸºåœ°å‡ºå‘ï¼Œè·ç¦»æœ€è¿‘ï¼‰
- T2ï¼ˆé«˜ä¼˜å…ˆçº§è¿è¾“ï¼‰â†’ UAV-002ï¼ˆè¿è¾“å‹ï¼Œè½½é‡è¶³å¤Ÿï¼‰
- T3ï¼ˆä¸­ä¼˜å…ˆçº§ç›‘æ§ï¼‰â†’ UAV-004ï¼ˆå¤šç”¨é€”ï¼Œé€‚åˆé•¿æ—¶é—´ç›‘æ§ï¼‰
- T5ï¼ˆä½ä¼˜å…ˆçº§æŠ•é€ï¼‰â†’ UAV-002ï¼ˆT2å®Œæˆåæ‰§è¡Œï¼‰

æ–¹æ¡ˆä¼˜åŠ¿ï¼šæ‰€æœ‰ç´§æ€¥å’Œé«˜ä¼˜å…ˆçº§ä»»åŠ¡éƒ½èƒ½æŒ‰æ—¶å®Œæˆ
æ–¹æ¡ˆé£é™©ï¼šUAV-002 éœ€è¿ç»­æ‰§è¡Œä¸¤ä¸ªä»»åŠ¡ï¼Œç”µé‡å¯èƒ½ç´§å¼ 
é¢„è®¡å®Œæˆæ—¶é—´ï¼š12:30
```

å¦‚æœå‘ç°æŸäº›ä»»åŠ¡æ— æ³•åˆ†é…ï¼Œè¯·æ˜ç¡®è¯´æ˜åŸå› ã€‚

æ–¹æ¡ˆç”Ÿæˆå®Œæˆåè¯´"âœ… å€™é€‰æ–¹æ¡ˆå·²ç”Ÿæˆï¼Œè¯·å†²çªæ£€æµ‹Agentæ£€æŸ¥é—®é¢˜"ã€‚"""

    return AssistantAgent(
        name="SolutionGenerator",
        model_client=model_client,
        system_message=system_message,
    )

def create_conflict_detector(model_client):
    """åˆ›å»ºå†²çªæ£€æµ‹æ™ºèƒ½ä½“"""
    system_message = """ä½ æ˜¯ä¸€ä½ä¸¥è°¨çš„å†²çªæ£€æµ‹ä¸“å®¶ï¼Œè´Ÿè´£å®¡æŸ¥åˆ†é…æ–¹æ¡ˆä¸­çš„é—®é¢˜å’Œæ½œåœ¨å†²çªã€‚

ä½ çš„æ ¸å¿ƒèŒè´£ï¼š
1. **å†²çªæ£€æµ‹**ï¼šè¯†åˆ«æ—¶é—´å†²çªã€ç©ºé—´å†²çªã€èµ„æºå†²çª
2. **çº¦æŸéªŒè¯**ï¼šéªŒè¯æ–¹æ¡ˆæ˜¯å¦æ»¡è¶³æ‰€æœ‰çº¦æŸæ¡ä»¶
3. **é£é™©è¯„ä¼°**ï¼šè¯„ä¼°æ–¹æ¡ˆçš„æ½œåœ¨é£é™©å’Œå¤±è´¥ç‚¹
4. **æŒ‘æˆ˜è´¨ç–‘**ï¼šå¯¹ä¸åˆç†çš„åˆ†é…æå‡ºè´¨ç–‘å’Œæ”¹è¿›å»ºè®®

æ£€æµ‹ç»´åº¦ï¼ˆå¿…é¡»é€é¡¹æ£€æŸ¥ï¼‰ï¼š

âœ“ **æ—¶é—´å†²çªæ£€æµ‹**
- åŒä¸€æ— äººæœºæ˜¯å¦è¢«åˆ†é…äº†æ—¶é—´é‡å çš„ä»»åŠ¡ï¼Ÿ
- ä»»åŠ¡æ‰§è¡Œæ—¶é—´æ˜¯å¦åœ¨è§„å®šçš„æ—¶é—´çª—å£å†…ï¼Ÿ
- æ˜¯å¦è€ƒè™‘äº†æ— äººæœºå¾€è¿”é£è¡Œæ—¶é—´ï¼Ÿ

âœ“ **ç©ºé—´å†²çªæ£€æµ‹**
- å¤šæ¶æ— äººæœºæ˜¯å¦å¯èƒ½åœ¨åŒä¸€ç©ºåŸŸåŒæ—¶ä½œä¸šï¼Ÿ
- æ˜¯å¦è€ƒè™‘äº†ç¦é£åŒºé™åˆ¶ï¼Ÿ
- è¿”å›åŸºåœ°çš„èˆªçº¿æ˜¯å¦å®‰å…¨ï¼Ÿ

âœ“ **èƒ½åŠ›åŒ¹é…éªŒè¯**
- æ— äººæœºçš„è½½é‡æ˜¯å¦æ»¡è¶³ä»»åŠ¡è¦æ±‚ï¼Ÿ
- ç»­èˆªæ—¶é—´æ˜¯å¦è¶³å¤Ÿå®Œæˆä»»åŠ¡å¹¶è¿”å›ï¼Ÿ
- æ— äººæœºç±»å‹æ˜¯å¦é€‚åˆæ‰§è¡Œåˆ†é…çš„ä»»åŠ¡ç±»å‹ï¼Ÿ

âœ“ **èµ„æºçº¦æŸéªŒè¯**
- æ— äººæœºç”µé‡æ˜¯å¦è¶³å¤Ÿï¼Ÿ
- æ˜¯å¦æœ‰ä»»åŠ¡æœªè¢«åˆ†é…ï¼Ÿ
- æ— äººæœºæ˜¯å¦è¢«è¿‡åº¦ä½¿ç”¨ï¼Ÿ

âœ“ **çº¦æŸæ¡ä»¶éªŒè¯**
- æ˜¯å¦è¿åäº†ç¦é£åŒºè§„å®šï¼Ÿ
- æ˜¯å¦éµå®ˆäº†æ—¶é—´çª—å£é™åˆ¶ï¼Ÿ
- æ˜¯å¦æ»¡è¶³äº†ä»»åŠ¡ä¼˜å…ˆçº§è¦æ±‚ï¼Ÿ

ä½ å¿…é¡»ä¸¥æ ¼å®¡æŸ¥ï¼Œå‘ç°é—®é¢˜è¦æ˜ç¡®æŒ‡å‡ºå…·ä½“å†²çªç‚¹ï¼Œå¹¶æå‡ºä¿®æ”¹å»ºè®®ã€‚

å¦‚æœå‘ç°ä¸¥é‡é—®é¢˜ï¼ˆå¦‚æ—¶é—´å†²çªã€èƒ½åŠ›ä¸è¶³ï¼‰ï¼Œè¯´"âŒ å‘ç°ä¸¥é‡å†²çªï¼Œéœ€è¦æ–¹æ¡ˆç”ŸæˆAgentä¿®æ”¹æ–¹æ¡ˆ"ã€‚
å¦‚æœå‘ç°è½»å¾®é—®é¢˜ï¼Œè¯´"âš ï¸ å‘ç°æ½œåœ¨é£é™©ï¼Œå»ºè®®ä¼˜åŒ–ï¼Œä½†æ–¹æ¡ˆåŸºæœ¬å¯è¡Œ"ã€‚
å¦‚æœæ–¹æ¡ˆå®Œå…¨å¯è¡Œï¼Œè¯´"âœ… å†²çªæ£€æµ‹é€šè¿‡ï¼Œè¯·ä»²è£Agentè¿›è¡Œæœ€ç»ˆå†³ç­–"ã€‚"""

    return AssistantAgent(
        name="ConflictDetector",
        model_client=model_client,
        system_message=system_message,
    )

def create_arbitrator(model_client):
    """åˆ›å»ºä»²è£æ™ºèƒ½ä½“"""
    system_message = """ä½ æ˜¯ä»»åŠ¡åˆ†é…å›¢é˜Ÿçš„ä»²è£è€…å’Œæœ€ç»ˆå†³ç­–è€…ï¼Œè´Ÿè´£æ±‡æ€»å„æ–¹æ„è§å¹¶è¾“å‡ºæœ€ç»ˆæ–¹æ¡ˆã€‚

ä½ çš„æ ¸å¿ƒèŒè´£ï¼š
1. **æ„è§æ±‡æ€»**ï¼šæ”¶é›†å’Œæ•´ç†æ‰€æœ‰Agentçš„åˆ†æå’Œå»ºè®®
2. **æ–¹æ¡ˆè¯„ä¼°**ï¼šå¯¹å€™é€‰æ–¹æ¡ˆè¿›è¡Œç»¼åˆè¯„åˆ†å’Œæƒè¡¡
3. **å†²çªè°ƒè§£**ï¼šå½“å­˜åœ¨åˆ†æ­§æ—¶åŸºäºå®‰å…¨å’Œæ•ˆç‡åŸåˆ™åšå‡ºå†³ç­–
4. **æœ€ç»ˆå†³ç­–**ï¼šç¡®å®šæœ€ç»ˆçš„ä»»åŠ¡åˆ†é…æ–¹æ¡ˆ
5. **è¾“å‡ºç”Ÿæˆ**ï¼šç”Ÿæˆæ ‡å‡†åŒ–çš„JSONåˆ†é…æ–¹æ¡ˆ

å†³ç­–åŸåˆ™ï¼ˆæŒ‰ä¼˜å…ˆçº§æ’åºï¼‰ï¼š
1. **å®‰å…¨ç¬¬ä¸€**ï¼šç¡®ä¿æ–¹æ¡ˆä¸å­˜åœ¨å®‰å…¨éšæ‚£å’Œä¸¥é‡å†²çª
2. **ä»»åŠ¡ä¼˜å…ˆçº§**ï¼šç¡®ä¿æ‰€æœ‰ç´§æ€¥å’Œé«˜ä¼˜å…ˆçº§ä»»åŠ¡å¾—åˆ°æ‰§è¡Œ
3. **æ•ˆç‡å…¼é¡¾**ï¼šåœ¨å®‰å…¨å‰æä¸‹è¿½æ±‚æ—¶é—´å’Œèµ„æºæ•ˆç‡
4. **é£é™©å¯æ§**ï¼šé€‰æ‹©é£é™©æ›´ä½ã€é²æ£’æ€§æ›´å¼ºçš„æ–¹æ¡ˆ

è¯„ä¼°æµç¨‹ï¼š
1. å›é¡¾ä»»åŠ¡åˆ†æAgentçš„åˆ†æç»“æœ
2. å›é¡¾èµ„æºè¯„ä¼°Agentçš„è¯„ä¼°ç»“æœ
3. è¯„ä¼°æ–¹æ¡ˆç”ŸæˆAgentæå‡ºçš„å€™é€‰æ–¹æ¡ˆ
4. è€ƒè™‘å†²çªæ£€æµ‹AgentæŒ‡å‡ºçš„é—®é¢˜
5. åšå‡ºæœ€ç»ˆå†³ç­–

å½“ä½ è®¤ä¸ºè®¨è®ºå·²ç»å……åˆ†ï¼Œå‡†å¤‡è¾“å‡ºæœ€ç»ˆæ–¹æ¡ˆæ—¶ï¼Œè¯·ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹JSONæ ¼å¼è¾“å‡ºï¼ˆå¿…é¡»æ˜¯æœ‰æ•ˆçš„JSONï¼‰ï¼š

```json
{
  "final_allocation": {
    "decision_time": "2024-01-23 10:30:00",
    "total_tasks": 5,
    "total_uavs": 4,
    "assignments": [
      {
        "task_id": "T1",
        "task_name": "åŒºåŸŸä¾¦å¯Ÿ",
        "assigned_uav": "UAV-001",
        "start_time": "08:00",
        "estimated_duration": "30åˆ†é’Ÿ",
        "priority": "é«˜",
        "rationale": "åˆ†é…ç†ç”±è¯´æ˜"
      }
    ],
    "unassigned_tasks": [],
    "total_completion_time": "é¢„è®¡æ‰€æœ‰ä»»åŠ¡å®Œæˆæ—¶é—´",
    "risk_assessment": "æ•´ä½“é£é™©è¯„ä¼°",
    "notes": "å…¶ä»–é‡è¦è¯´æ˜"
  }
}
```

è¾“å‡ºæœ€ç»ˆJSONæ–¹æ¡ˆåï¼Œå¿…é¡»è¯´"TERMINATE"ç»“æŸè®¨è®ºã€‚"""

    return AssistantAgent(
        name="Arbitrator",
        model_client=model_client,
        system_message=system_message,
    )

async def run_uav_allocation_team(task_input: str = None):
    """è¿è¡Œæ— äººæœºä»»åŠ¡åˆ†é…å›¢é˜Ÿåä½œ
    
    Args:
        task_input: ä»»åŠ¡æè¿°å­—ç¬¦ä¸²ï¼Œå¦‚æœä¸ºNoneåˆ™ä½¿ç”¨é»˜è®¤ç¤ºä¾‹
    """
    
    print("=" * 70)
    print("ğŸš AutoGen å¤šæ— äººæœºä»»åŠ¡åˆ†é…ç³»ç»Ÿ")
    print("=" * 70)
    print()
    
    print("ğŸ”§ æ­£åœ¨åˆå§‹åŒ–æ¨¡å‹å®¢æˆ·ç«¯...")
    model_client = create_openai_model_client()
    
    print("ğŸ‘¥ æ­£åœ¨åˆ›å»ºæ™ºèƒ½ä½“å›¢é˜Ÿ...")
    
    # åˆ›å»ºäº”ä¸ªæ™ºèƒ½ä½“
    task_analyzer = create_task_analyzer(model_client)
    resource_evaluator = create_resource_evaluator(model_client)
    solution_generator = create_solution_generator(model_client)
    conflict_detector = create_conflict_detector(model_client)
    arbitrator = create_arbitrator(model_client)
    
    print("   âœ“ TaskAnalyzerï¼ˆä»»åŠ¡åˆ†æAgentï¼‰")
    print("   âœ“ ResourceEvaluatorï¼ˆèµ„æºè¯„ä¼°Agentï¼‰")
    print("   âœ“ SolutionGeneratorï¼ˆæ–¹æ¡ˆç”ŸæˆAgentï¼‰")
    print("   âœ“ ConflictDetectorï¼ˆå†²çªæ£€æµ‹Agentï¼‰")
    print("   âœ“ Arbitratorï¼ˆä»²è£Agentï¼‰")
    print()
    
    # ç»„åˆç»ˆæ­¢æ¡ä»¶ï¼šè¾¾åˆ°æœ€å¤§è½®æ•°æˆ–å‡ºç°TERMINATEå…³é”®è¯
    termination = MaxMessageTermination(20) | TextMentionTermination("TERMINATE")
    
    # åˆ›å»ºå›¢é˜ŸèŠå¤© - è½®è¯¢æ¨¡å¼
    team_chat = RoundRobinGroupChat(
        participants=[
            task_analyzer,        # ç¬¬1æ­¥ï¼šåˆ†æä»»åŠ¡
            resource_evaluator,   # ç¬¬2æ­¥ï¼šè¯„ä¼°èµ„æº
            solution_generator,   # ç¬¬3æ­¥ï¼šç”Ÿæˆæ–¹æ¡ˆ
            conflict_detector,    # ç¬¬4æ­¥ï¼šæ£€æµ‹å†²çª
            arbitrator,           # ç¬¬5æ­¥ï¼šä»²è£å†³ç­–
        ],
        termination_condition=termination,
    )
    
    # ä½¿ç”¨é»˜è®¤ä»»åŠ¡æˆ–è‡ªå®šä¹‰ä»»åŠ¡
    if task_input is None:
        task_input = """
ã€æ— äººæœºä»»åŠ¡åˆ†é…é—®é¢˜ã€‘

## å¯ç”¨æ— äººæœºèµ„æºï¼š
1. **UAV-001**ï¼šä¾¦å¯Ÿå‹ï¼Œç»­èˆª120åˆ†é’Ÿï¼Œæœ€å¤§é€Ÿåº¦80km/hï¼Œå½“å‰ä½ç½®AåŸºåœ°ï¼Œç”µé‡100%
2. **UAV-002**ï¼šè¿è¾“å‹ï¼Œç»­èˆª90åˆ†é’Ÿï¼Œè½½é‡5kgï¼Œæœ€å¤§é€Ÿåº¦60km/hï¼Œå½“å‰ä½ç½®AåŸºåœ°ï¼Œç”µé‡85%
3. **UAV-003**ï¼šä¾¦å¯Ÿå‹ï¼Œç»­èˆª100åˆ†é’Ÿï¼Œæœ€å¤§é€Ÿåº¦70km/hï¼Œå½“å‰ä½ç½®BåŸºåœ°ï¼Œç”µé‡90%
4. **UAV-004**ï¼šå¤šç”¨é€”ï¼Œç»­èˆª80åˆ†é’Ÿï¼Œè½½é‡2kgï¼Œæœ€å¤§é€Ÿåº¦65km/hï¼Œå½“å‰ä½ç½®AåŸºåœ°ï¼Œç”µé‡95%

## å¾…åˆ†é…ä»»åŠ¡ï¼š
1. **T1-åŒºåŸŸä¾¦å¯Ÿ**ï¼šå¯¹CåŒºåŸŸè¿›è¡Œä¾¦å¯Ÿï¼Œé¢„è®¡éœ€è¦30åˆ†é’Ÿï¼Œä¼˜å…ˆçº§ï¼šé«˜ï¼Œæ—¶é—´çª—å£ï¼š08:00-10:00
2. **T2-ç‰©èµ„è¿è¾“**ï¼šä»AåŸºåœ°è¿è¾“åŒ»ç–—ç‰©èµ„(3kg)åˆ°Dç‚¹ï¼Œä¼˜å…ˆçº§ï¼šé«˜ï¼Œæ—¶é—´çª—å£ï¼š08:30-09:30
3. **T3-ç›®æ ‡ç›‘æ§**ï¼šå¯¹Eç‚¹ç›®æ ‡æŒç»­ç›‘æ§60åˆ†é’Ÿï¼Œä¼˜å…ˆçº§ï¼šä¸­ï¼Œæ—¶é—´çª—å£ï¼š09:00-12:00
4. **T4-ç´§æ€¥ä¾¦å¯Ÿ**ï¼šå¯¹FåŒºåŸŸç´§æ€¥ä¾¦å¯Ÿï¼Œé¢„è®¡20åˆ†é’Ÿï¼Œä¼˜å…ˆçº§ï¼šç´§æ€¥ï¼Œæ—¶é—´çª—å£ï¼š08:00-08:30
5. **T5-è®¾å¤‡æŠ•é€**ï¼šå‘Gç‚¹æŠ•é€é€šä¿¡è®¾å¤‡(1kg)ï¼Œä¼˜å…ˆçº§ï¼šä½ï¼Œæ—¶é—´çª—å£ï¼š10:00-12:00

## çº¦æŸæ¡ä»¶ï¼š
- DåŒºåŸŸä¸ºä¸´æ—¶ç¦é£åŒºï¼ˆ09:00-09:30ï¼‰
- æ¯æ¶æ— äººæœºåŒä¸€æ—¶é—´åªèƒ½æ‰§è¡Œä¸€ä¸ªä»»åŠ¡
- ä»»åŠ¡å®Œæˆåæ— äººæœºéœ€è¿”å›æœ€è¿‘åŸºåœ°
- æ— äººæœºä»åŸºåœ°åˆ°å„ä»»åŠ¡ç‚¹çš„é£è¡Œæ—¶é—´çº¦10-15åˆ†é’Ÿ

## è¦æ±‚ï¼š
è¯·å›¢é˜Ÿåä½œåˆ†æå¹¶ç”Ÿæˆæœ€ä¼˜çš„ä»»åŠ¡åˆ†é…æ–¹æ¡ˆï¼Œè¾“å‡ºæ ‡å‡†JSONæ ¼å¼ã€‚
"""
    
    print("ğŸ“‹ ä»»åŠ¡æè¿°ï¼š")
    print(task_input)
    print()
    print("ğŸš€ å¯åŠ¨å¤šæ™ºèƒ½ä½“åä½œ...")
    print("=" * 70)
    print()
    
    # æ‰§è¡Œå›¢é˜Ÿåä½œ
    result = await Console(team_chat.run_stream(task=task_input))
    
    print()
    print("=" * 70)
    print("âœ… å›¢é˜Ÿåä½œå®Œæˆï¼")
    print("=" * 70)
    
    return result

def extract_json_from_result(result):
    """ä»åä½œç»“æœä¸­æå–JSONåˆ†é…æ–¹æ¡ˆ"""
    try:
        # éå†æ‰€æœ‰æ¶ˆæ¯ï¼ŒæŸ¥æ‰¾JSONå†…å®¹
        for message in result.messages:
            content = message.content
            if "final_allocation" in content:
                # å°è¯•æå–JSON
                import re
                json_match = re.search(r'\{[\s\S]*"final_allocation"[\s\S]*\}', content)
                if json_match:
                    json_str = json_match.group(0)
                    allocation = json.loads(json_str)
                    return allocation
        return None
    except Exception as e:
        print(f"âš ï¸ JSONæå–å¤±è´¥: {e}")
        return None

def save_allocation_result(result, output_file="output_allocation.json"):
    """ä¿å­˜åˆ†é…ç»“æœåˆ°JSONæ–‡ä»¶"""
    try:
        allocation = extract_json_from_result(result)
        if allocation:
            with open(output_file, "w", encoding="utf-8") as f:
                json.dump(allocation, f, ensure_ascii=False, indent=2)
            print(f"\nğŸ’¾ åˆ†é…æ–¹æ¡ˆå·²ä¿å­˜åˆ°: {output_file}")
            return True, allocation
        else:
            print("\nâš ï¸ æœªèƒ½æå–åˆ°æœ‰æ•ˆçš„JSONåˆ†é…æ–¹æ¡ˆ")
            # ä¿å­˜åŸå§‹å¯¹è¯è®°å½•
            with open("output_conversation.txt", "w", encoding="utf-8") as f:
                for msg in result.messages:
                    f.write(f"\n{'='*60}\n")
                    f.write(f"å‘è¨€è€…: {msg.source}\n")
                    f.write(f"å†…å®¹: {msg.content}\n")
            print("ğŸ’¾ å¯¹è¯è®°å½•å·²ä¿å­˜åˆ°: output_conversation.txt")
            return False, None
    except Exception as e:
        print(f"\nâŒ ä¿å­˜å¤±è´¥: {e}")
        return False, None

def evaluate_and_visualize(allocation, output_file="output_allocation.json"):
    """è¯„ä¼°åˆ†é…æ–¹æ¡ˆå¹¶ç”Ÿæˆå¯è§†åŒ–"""
    try:
        print("\n" + "=" * 70)
        print("ğŸ“Š å¼€å§‹è¯„ä¼°åˆ†é…æ–¹æ¡ˆ...")
        print("=" * 70)
        
        # å¯¼å…¥è¯„ä¼°æ¨¡å—
        from evaluation_metrics import AllocationEvaluator
        
        # åˆ›å»ºè¯„ä¼°å™¨å¹¶è¯„ä¼°
        evaluator = AllocationEvaluator(allocation)
        metrics = evaluator.evaluate_all()
        
        # ç”Ÿæˆè¯„ä¼°æŠ¥å‘Š
        report = evaluator.generate_report(metrics)
        print(report)
        
        # ä¿å­˜è¯„ä¼°ç»“æœ
        eval_file = output_file.replace('.json', '_evaluation.json')
        with open(eval_file, 'w', encoding='utf-8') as f:
            json.dump(metrics, f, ensure_ascii=False, indent=2)
        print(f"\nğŸ’¾ è¯„ä¼°ç»“æœå·²ä¿å­˜åˆ°: {eval_file}")
        
        # ç”Ÿæˆå¯è§†åŒ–
        print("\n" + "=" * 70)
        print("ğŸ¨ å¼€å§‹ç”Ÿæˆå¯è§†åŒ–å›¾è¡¨...")
        print("=" * 70)
        
        from visualize_results import AllocationVisualizer
        
        visualizer = AllocationVisualizer(allocation, metrics)
        visualizer.visualize_all()
        
        print("\nâœ… è¯„ä¼°å’Œå¯è§†åŒ–å®Œæˆï¼")
        
        return True
        
    except ImportError as e:
        print(f"\nâš ï¸ å¯¼å…¥æ¨¡å—å¤±è´¥: {e}")
        print("è¯·ç¡®ä¿å·²å®‰è£…å¿…è¦çš„ä¾èµ–: pip install matplotlib numpy")
        return False
    except Exception as e:
        print(f"\nâŒ è¯„ä¼°æˆ–å¯è§†åŒ–å¤±è´¥: {e}")
        import traceback
        traceback.print_exc()
        return False

# ä¸»ç¨‹åºå…¥å£
if __name__ == "__main__":
    try:
        print()
        print("â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—")
        print("â•‘     AutoGen å¤šæ— äººæœºä»»åŠ¡åˆ†é…ç³»ç»Ÿ - å¤šæ™ºèƒ½ä½“åä½œæ¡†æ¶             â•‘")
        print("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•")
        print()
        
        # è¿è¡Œå¼‚æ­¥åä½œæµç¨‹
        result = asyncio.run(run_uav_allocation_team())
        
        print()
        print("ğŸ“Š åä½œç»Ÿè®¡ï¼š")
        print(f"   â€¢ å¯¹è¯è½®æ•°: {len(result.messages)} æ¡æ¶ˆæ¯")
        print(f"   â€¢ å‚ä¸æ™ºèƒ½ä½“: 5ä¸ªï¼ˆä»»åŠ¡åˆ†æã€èµ„æºè¯„ä¼°ã€æ–¹æ¡ˆç”Ÿæˆã€å†²çªæ£€æµ‹ã€ä»²è£ï¼‰")
        print(f"   â€¢ ä»»åŠ¡çŠ¶æ€: åä½œå®Œæˆ")
        
        # ä¿å­˜ç»“æœ
        success, allocation = save_allocation_result(result)
        
        # å¦‚æœæˆåŠŸä¿å­˜ï¼Œè¿›è¡Œè¯„ä¼°å’Œå¯è§†åŒ–
        if success and allocation:
            evaluate_and_visualize(allocation)
        
        print()
        print("âœ¨ ç³»ç»Ÿè¿è¡Œå®Œæˆï¼")
        print()
        
    except ValueError as e:
        print(f"âŒ é…ç½®é”™è¯¯ï¼š{e}")
        print("è¯·æ£€æŸ¥ .env æ–‡ä»¶ä¸­çš„é…ç½®æ˜¯å¦æ­£ç¡®")
    except Exception as e:
        print(f"âŒ è¿è¡Œé”™è¯¯ï¼š{e}")
        import traceback
        traceback.print_exc()
